# ğŸ“˜ 0. ì˜ˆìƒë˜ëŠ” ë¬¸ì œì  ë° ì˜ˆë°©ë²•

> **ëª©ì **: ë‹¤ì¤‘ í”„ë¡œì íŠ¸ EC2 ìš´ì˜ ì‹œ ìì£¼ ê²ªëŠ” ë¬¸ì œì™€ í•´ê²°ì±…

---

## 1. Docker ê²©ë¦¬ ì›ë¦¬ - í•µì‹¬ ë‹µë³€

### âœ… ê° í”„ë¡œì íŠ¸ë§ˆë‹¤ Dockerë¥¼ ë„ìš¸ ìˆ˜ ìˆë‚˜ìš”?

**ë„¤, ê°€ëŠ¥í•©ë‹ˆë‹¤!** ê° í”„ë¡œì íŠ¸ëŠ” ì™„ì „íˆ ë…ë¦½ëœ Docker ì»¨í…Œì´ë„ˆì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.

```
EC2 ì¸ìŠ¤í„´ìŠ¤
â”œâ”€â”€ Project 1 (docker-compose.yml)
â”‚   â”œâ”€â”€ project1-app (Django)
â”‚   â””â”€â”€ project1-db (PostgreSQL)
â”‚
â”œâ”€â”€ Project 2 (docker-compose.yml)
â”‚   â”œâ”€â”€ project2-app (FastAPI)
â”‚   â””â”€â”€ project2-db (PostgreSQL)  â† ì™„ì „íˆ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆ!
â”‚
â”œâ”€â”€ Project 3 ...
â””â”€â”€ ...
```

### âœ… PostgreSQLì€ ì–´ë–»ê²Œ êµ¬ë¶„ë˜ë‚˜ìš”?

**ê° í”„ë¡œì íŠ¸ë§ˆë‹¤ ë³„ë„ì˜ PostgreSQL ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.**

```yaml
# Project 1ì˜ docker-compose.yml
services:
  db:
    image: postgres:15
    container_name: project1-db  # â† ê³ ìœ  ì´ë¦„
    volumes:
      - project1_postgres:/var/lib/postgresql/data  # â† ê³ ìœ  ë³¼ë¥¨

# Project 2ì˜ docker-compose.yml  
services:
  db:
    image: postgres:15
    container_name: project2-db  # â† ë‹¤ë¥¸ ì´ë¦„!
    volumes:
      - project2_postgres:/var/lib/postgresql/data  # â† ë‹¤ë¥¸ ë³¼ë¥¨!
```

**ì™œ ê²¹ì¹˜ì§€ ì•ŠëŠ”ê°€?**

| êµ¬ë¶„ ìš”ì†Œ | ì˜ˆì‹œ | ì—­í•  |
|----------|------|------|
| ì»¨í…Œì´ë„ˆ ì´ë¦„ | `project1-db`, `project2-db` | ì»¨í…Œì´ë„ˆ ì‹ë³„ì |
| ë³¼ë¥¨ ì´ë¦„ | `project1_postgres`, `project2_postgres` | ë°ì´í„° ì €ì¥ ìœ„ì¹˜ ë¶„ë¦¬ |
| ë„¤íŠ¸ì›Œí¬ | `project1-internal`, `project2-internal` | ë‚´ë¶€ í†µì‹  ê²©ë¦¬ |

### âœ… .env íŒŒì¼ë„ ê²¹ì¹˜ì§€ ì•Šë‚˜ìš”?

**ê° í”„ë¡œì íŠ¸ í´ë”ì— ê°œë³„ .env íŒŒì¼**ì´ ìˆìœ¼ë¯€ë¡œ ì ˆëŒ€ ê²¹ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```
~/projects/
â”œâ”€â”€ project1-neighborbid/
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â””â”€â”€ .env              â† Project 1 ì „ìš©
â”‚
â”œâ”€â”€ project2-fastapi/
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â””â”€â”€ .env              â† Project 2 ì „ìš© (ì™„ì „ ë³„ê°œ íŒŒì¼)
â”‚
â””â”€â”€ project3/
    â””â”€â”€ .env              â† Project 3 ì „ìš©
```

**ê° .env ì˜ˆì‹œ:**

```bash
# ~/projects/project1-neighborbid/.env
POSTGRES_DB=neighborbid_db
POSTGRES_USER=project1_user
POSTGRES_PASSWORD=project1_secret
APP_PORT=8001


# ~/projects/project2-fastapi/.env
POSTGRES_DB=fastapi_db
POSTGRES_USER=project2_user
POSTGRES_PASSWORD=project2_secret
APP_PORT=8002
```

---

## 2. ì˜ˆìƒë˜ëŠ” ë¬¸ì œì  ë° ì˜ˆë°©ë²•

### ğŸš¨ ë¬¸ì œ 1: í¬íŠ¸ ì¶©ëŒ

**ì¦ìƒ**: `Bind for 0.0.0.0:8000 failed: port is already allocated`

**ì›ì¸**: ë‘ í”„ë¡œì íŠ¸ê°€ ê°™ì€ í¬íŠ¸ ì‚¬ìš©

**ì˜ˆë°©ë²•**:
```yaml
# ê° í”„ë¡œì íŠ¸ì— ë‹¤ë¥¸ í¬íŠ¸ í• ë‹¹
# Project 1
ports:
  - "8001:8000"

# Project 2
ports:
  - "8002:8000"
```

**í¬íŠ¸ í• ë‹¹ ê³„íší‘œ**:
| í”„ë¡œì íŠ¸ | ì™¸ë¶€ í¬íŠ¸ | ë‚´ë¶€ í¬íŠ¸ |
|----------|----------|----------|
| Project 1 | 8001 | 8000 |
| Project 2 | 8002 | 8000 |
| Project 3 | 8003 | 8000 |
| Project 4 | 8004 | 8000 |
| Project 5 | 8005 | 8000 |

---

### ğŸš¨ ë¬¸ì œ 2: ë©”ëª¨ë¦¬ ë¶€ì¡± (OOM Kill)

**ì¦ìƒ**: ì»¨í…Œì´ë„ˆê°€ ê°‘ìê¸° ì¢…ë£Œë¨, `docker logs`ì— "Killed" í‘œì‹œ

**ì›ì¸**: ì„œë²„ RAM ì´ˆê³¼

**ì˜ˆë°©ë²•**:
```yaml
# docker-compose.ymlì— ë©”ëª¨ë¦¬ ì œí•œ ì„¤ì •
services:
  app:
    deploy:
      resources:
        limits:
          memory: 512M

  opensearch:
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"  # Java í™ ì œí•œ
```

**ëª¨ë‹ˆí„°ë§**:
```bash
# ì‹¤ì‹œê°„ ë¦¬ì†ŒìŠ¤ í™•ì¸
docker stats

# ì „ì²´ ë©”ëª¨ë¦¬ í™•ì¸
free -h
```

---

### ğŸš¨ ë¬¸ì œ 3: ë””ìŠ¤í¬ ìš©ëŸ‰ ë¶€ì¡±

**ì¦ìƒ**: `No space left on device`

**ì›ì¸**: Docker ì´ë¯¸ì§€, ë¡œê·¸, ë³¼ë¥¨ ëˆ„ì 

**ì˜ˆë°©ë²•**:
```bash
# ì •ê¸°ì ìœ¼ë¡œ ì •ë¦¬ (ì£¼ 1íšŒ ê¶Œì¥)
docker system prune -af --volumes

# ë¡œê·¸ í¬ê¸° ì œí•œ (docker-compose.yml)
services:
  app:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

**ë””ìŠ¤í¬ í™•ì¸**:
```bash
df -h
docker system df
```

---

### ğŸš¨ ë¬¸ì œ 4: ì»¨í…Œì´ë„ˆ ì´ë¦„ ì¶©ëŒ

**ì¦ìƒ**: `Conflict. The container name "/db" is already in use`

**ì›ì¸**: ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ê°™ì€ ì»¨í…Œì´ë„ˆ ì´ë¦„ ì‚¬ìš©

**ì˜ˆë°©ë²•**:
```yaml
# í•­ìƒ í”„ë¡œì íŠ¸ prefix ë¶™ì´ê¸°
services:
  app:
    container_name: project1-app  # âœ… Good
  db:
    container_name: project1-db   # âœ… Good
```

---

### ğŸš¨ ë¬¸ì œ 5: DB ì—°ê²° ì‹¤íŒ¨

**ì¦ìƒ**: `connection refused`, `could not connect to server`

**ì›ì¸**: ì•±ì´ DBë³´ë‹¤ ë¨¼ì € ì‹œì‘ë¨

**ì˜ˆë°©ë²•**:
```yaml
services:
  app:
    depends_on:
      db:
        condition: service_healthy  # ê±´ê°• ì²´í¬ í›„ ì‹œì‘

  db:
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
```

---

### ğŸš¨ ë¬¸ì œ 6: Nginx 502 Bad Gateway

**ì¦ìƒ**: ë¸Œë¼ìš°ì €ì—ì„œ 502 ì—ëŸ¬

**ì›ì¸**: 
1. ë°±ì—”ë“œ ì•± ì»¨í…Œì´ë„ˆ ë¯¸ì‹¤í–‰
2. upstream ì´ë¦„ ì˜¤ë¥˜
3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì•ˆë¨

**ì§„ë‹¨ ë°©ë²•**:
```bash
# 1. ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
docker ps | grep project1

# 2. Nginx ì—ëŸ¬ ë¡œê·¸ í™•ì¸
docker logs portfolio-nginx

# 3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸
docker network inspect portfolio-network
```

**ì˜ˆë°©ë²•**:
```yaml
# ëª¨ë“  ì•± ì»¨í…Œì´ë„ˆê°€ portfolio-networkì— ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
networks:
  portfolio-network:
    external: true
```

---

### ğŸš¨ ë¬¸ì œ 7: SSL ì¸ì¦ì„œ ê°±ì‹  ì‹¤íŒ¨

**ì¦ìƒ**: HTTPS ì ‘ì† ë¶ˆê°€, ì¸ì¦ì„œ ë§Œë£Œ

**ì›ì¸**: Let's Encrypt ì¸ì¦ì„œ 90ì¼ ë§Œë£Œ

**ì˜ˆë°©ë²•**:
```bash
# ìë™ ê°±ì‹  í¬ë¡ ì¡ ì„¤ì •
sudo crontab -e

# ë§¤ì£¼ ì›”ìš”ì¼ ìƒˆë²½ 3ì‹œ ìë™ ê°±ì‹ 
0 3 * * 1 certbot renew --quiet && docker exec portfolio-nginx nginx -s reload
```

---

### ğŸš¨ ë¬¸ì œ 8: ë³¼ë¥¨ ë°ì´í„° ì†ì‹¤

**ì¦ìƒ**: ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ í›„ ë°ì´í„° ì‚¬ë¼ì§

**ì›ì¸**: ë³¼ë¥¨ ì„¤ì • ëˆ„ë½

**ì˜ˆë°©ë²•**:
```yaml
# ë°˜ë“œì‹œ named volume ì‚¬ìš©
volumes:
  - postgres_data:/var/lib/postgresql/data  # âœ… Named volume

# ì ˆëŒ€ ì´ë ‡ê²Œ í•˜ì§€ ë§ˆì„¸ìš”
# - ./data:/var/lib/postgresql/data  # âš ï¸ ê¶Œí•œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥
```

**ë°±ì—… ìŠ¤í¬ë¦½íŠ¸**:
```bash
#!/bin/bash
# ~/backup.sh
DATE=$(date +%Y%m%d)
docker exec project1-db pg_dump -U postgres dbname > ~/backups/project1_$DATE.sql
```

---

### ğŸš¨ ë¬¸ì œ 9: ì •ì  íŒŒì¼ 404

**ì¦ìƒ**: CSS/JS íŒŒì¼ ë¡œë”© ì‹¤íŒ¨

**ì›ì¸**: Nginxê°€ ì •ì  íŒŒì¼ ìœ„ì¹˜ë¥¼ ëª¨ë¦„

**ì˜ˆë°©ë²•**:
```yaml
# Django collectstatic ì‹¤í–‰
services:
  app:
    command: >
      sh -c "python manage.py collectstatic --noinput &&
             gunicorn config.wsgi:application --bind 0.0.0.0:8000"

# Nginxì—ì„œ ì •ì  íŒŒì¼ ì§ì ‘ ì„œë¹™
location /project1/static/ {
    alias /usr/share/nginx/html/project1/static/;
}
```

---

### ğŸš¨ ë¬¸ì œ 10: ì„œë²„ ì¬ë¶€íŒ… í›„ ì»¨í…Œì´ë„ˆ ë¯¸ì‹œì‘

**ì¦ìƒ**: EC2 ì¬ì‹œì‘ í›„ ì„œë¹„ìŠ¤ ì ‘ì† ë¶ˆê°€

**ì›ì¸**: Docker ì»¨í…Œì´ë„ˆ ìë™ ì‹œì‘ ì„¤ì • ëˆ„ë½

**ì˜ˆë°©ë²•**:
```yaml
# ëª¨ë“  ì„œë¹„ìŠ¤ì— restart ì •ì±… ì¶”ê°€
services:
  app:
    restart: unless-stopped

  db:
    restart: unless-stopped
```

---

## 3. ğŸ› ï¸ ì¢…í•© ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°°í¬ ì „ í™•ì¸

- [ ] ê° í”„ë¡œì íŠ¸ `.env` íŒŒì¼ ì¡´ì¬ ë° ê°’ ì„¤ì •
- [ ] ëª¨ë“  ì»¨í…Œì´ë„ˆ ì´ë¦„ì— í”„ë¡œì íŠ¸ prefix ìˆìŒ
- [ ] í¬íŠ¸ ì¶©ëŒ ì—†ìŒ (8001, 8002, 8003...)
- [ ] `restart: unless-stopped` ì„¤ì •ë¨
- [ ] `portfolio-network` ì—°ê²°ë¨
- [ ] ë³¼ë¥¨ ì´ë¦„ ê³ ìœ í•¨

### ë°°í¬ í›„ í™•ì¸

```bash
# ì „ì²´ ìƒíƒœ ì ê²€ ìŠ¤í¬ë¦½íŠ¸
#!/bin/bash
echo "=== Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ ==="
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

echo -e "\n=== ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ==="
free -h

echo -e "\n=== ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ==="
df -h /

echo -e "\n=== ê° í”„ë¡œì íŠ¸ í—¬ìŠ¤ì²´í¬ ==="
curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/health && echo " - Project 1 OK"
curl -s -o /dev/null -w "%{http_code}" http://localhost:8002/health && echo " - Project 2 OK"
```

---

## 4. ğŸ“Š ìš”ì•½ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        EC2 ì¸ìŠ¤í„´ìŠ¤                              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                  Docker Engine                           â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚    â”‚
â”‚  â”‚  â”‚   Project 1      â”‚  â”‚   Project 2      â”‚  ...        â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚             â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ app:8001 â”‚    â”‚  â”‚  â”‚ app:8002 â”‚    â”‚             â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚             â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚             â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ db       â”‚    â”‚  â”‚  â”‚ db       â”‚    â”‚  ê²©ë¦¬ë¨!    â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚             â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚             â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ .env     â”‚    â”‚  â”‚  â”‚ .env     â”‚    â”‚  ê°œë³„ íŒŒì¼! â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚             â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚             â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ volume   â”‚    â”‚  â”‚  â”‚ volume   â”‚    â”‚  ê°œë³„ ì €ì¥! â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚             â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
