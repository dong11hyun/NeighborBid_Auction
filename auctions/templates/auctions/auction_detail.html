{% extends 'auctions/base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        {% if auction.image %}
            <img src="{{ auction.image.url }}" class="img-fluid rounded" alt="{{ auction.title }}">
        {% else %}
            <div class="bg-secondary text-white p-5 text-center rounded">ì´ë¯¸ì§€ ì—†ìŒ</div>
        {% endif %}
    </div>

    <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center">
            <h2>{{ auction.title }}</h2>
            
            {% if user.is_authenticated %}
                <a href="{% url 'toggle_watchlist' auction.id %}" class="btn btn-outline-danger btn-sm">
                    {% if request.user in auction.watchers.all %}
                        â¤ï¸ ì°œ ì·¨ì†Œ
                    {% else %}
                        ğŸ¤ ì°œí•˜ê¸°
                    {% endif %}
                </a>
            {% endif %}
        </div>

        <p class="text-muted">íŒë§¤ì: {{ auction.seller.username }} | ë§ˆê°: {{ auction.end_time }}</p>
        <hr>
        <p>{{ auction.description }}</p>
        
        {% if request.user == auction.seller %}
        <div class="card border-warning mt-4">
            <div class="card-body">
                <h5 class="card-title text-warning fw-bold">ğŸ‘¨â€ğŸ’¼ íŒë§¤ì ê´€ë¦¬ ë©”ë‰´</h5>
                <p class="card-text small text-muted">ì¢…ë£Œ ì‹œê°„ì´ ì§€ë‚¬ê±°ë‚˜ ë‚™ì°°ì„ ì›í•˜ì‹œë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                
                {% if auction.status == 'ACTIVE' %}
                    <form action="{% url 'auction_close' auction.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning w-100 fw-bold">ğŸš« ê²½ë§¤ ì¢…ë£Œ ë° ë‚™ì°° í™•ì •</button>
                    </form>
                {% else %}
                    <button class="btn btn-secondary w-100" disabled>ì´ë¯¸ ì¢…ë£Œëœ ê²½ë§¤ì…ë‹ˆë‹¤</button>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if auction.instant_price and auction.status == 'ACTIVE' %}
            <div class="mt-3">
            <hr>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-success">ì¦‰ì‹œ êµ¬ë§¤ ê°€ëŠ¥</span>
                    <h4 class="text-success fw-bold">{{ auction.instant_price }}ì›</h4>
                </div>
            
                <form action="{% url 'auction_buy_now' auction.id %}" method="post" onsubmit="return confirm('ì •ë§ ì¦‰ì‹œ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-lg">
                        âš¡ ì§€ê¸ˆ ë°”ë¡œ êµ¬ë§¤í•˜ê¸°
                    </button>
                </form>
            </div>
            <p class="text-muted small mt-1">ì¦‰ì‹œ êµ¬ë§¤ ì‹œ ê²½ë§¤ê°€ ë°”ë¡œ ì¢…ë£Œë©ë‹ˆë‹¤.</p>
        </div>
        {% endif %}

        <div class="card bg-light mt-4">
            <div class="card-body">
                <div class="d-flex justify-content-center align-items-center mb-4">
                    <div class="text-center me-5">
                        <span class="text-muted small">ì‹œì‘ê°€</span>
                        <h3 class="text-secondary">{{ auction.start_price }}ì›</h3>
                    </div>

                    <div style="border-left: 1px solid #ccc; height: 40px;"></div>

                    <div class="text-center ms-5">
                        <span class="text-danger small fw-bold">í˜„ì¬ê°€</span>
                        <h3 class="text-danger">
                            {% if auction.current_price > 0 %}
                                {{ auction.current_price }}
                            {% else %}
                                {{ auction.start_price }}
                            {% endif %}ì›
                        </h3>
                    </div>
                </div>
                
                <form method="post">
                    {% csrf_token %}
                    <div class="input-group mb-3">
                        <span class="input-group-text">ì…ì°°ê¸ˆì•¡</span>
                        <input type="number" name="amount" class="form-control" 
                               value="{{ auction.current_price|add:auction.bid_unit }}" 
                               min="{{ auction.current_price|add:auction.bid_unit }}">
                        <button class="btn btn-danger" type="submit">ì…ì°°í•˜ê¸° ğŸ”¨</button>
                    </div>
                    <p class="text-muted small text-center">* ìµœì†Œ ì…ì°° ë‹¨ìœ„: {{ auction.bid_unit }}ì›</p>
                </form>
            </div>
        </div>

        <h4 class="mt-5">ğŸ“‹ ì…ì°° ê¸°ë¡</h4>
        <ul class="list-group">
            {% for bid in auction.bids.all|dictsortreversed:"amount" %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ bid.bidder.username }}
                    <span class="badge bg-secondary rounded-pill">{{ bid.amount }}ì›</span>
                </li>
            {% empty %}
                <li class="list-group-item">ì•„ì§ ì…ì°°ì´ ì—†ìŠµë‹ˆë‹¤. 1ë“±ì„ ë…¸ë ¤ë³´ì„¸ìš”!</li>
            {% endfor %}
        </ul>

        <hr class="my-5">

        <h4 class="mb-3">ğŸ’¬ ìƒí’ˆ ë¬¸ì˜</h4>
        <form action="{% url 'auction_comment' auction.id %}" method="post" class="mb-4">
            {% csrf_token %}
            <div class="input-group">
                <textarea name="content" class="form-control" rows="3" placeholder="ë¬¸ì˜ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                <button class="btn btn-dark" type="submit">ë“±ë¡</button>
            </div>
        </form>

        <div class="list-group">
            {% for comment in auction.comments.all %}
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1 fw-bold">ğŸ‘¤ {{ comment.writer.nickname|default:comment.writer.username }}</h6>
                        <small class="text-muted">{{ comment.created_at|date:"Y-m-d H:i" }}</small>
                    </div>
                    <p class="mb-1">{{ comment.content }}</p>
                </div>
            {% empty %}
                <p class="text-muted text-center">ì•„ì§ ë“±ë¡ëœ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endfor %}
        </div>

        <div class="mb-5"></div>
    </div>
</div>
{% endblock %}