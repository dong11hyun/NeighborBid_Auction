{% extends 'auctions/base.html' %}
{% load static %} 

{% block content %}
<div class="container mt-4">
    
    <input type="hidden" id="current-user-id" value="{{ user.id|default_if_none:'' }}">
    
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-light p-2 rounded">
            <li class="breadcrumb-item"><a href="{% url 'auction_list' %}" class="text-decoration-none text-muted">í™ˆ</a></li>
            {% if auction.category %}
            <li class="breadcrumb-item"><a href="{% url 'auction_list' %}?category={{ auction.category.slug }}" class="text-decoration-none text-muted">{{ auction.category.name }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{{ auction.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-7">
            <div class="card border-0">
                {% if auction.image %}
                    <img src="{{ auction.image.url }}" class="img-fluid rounded shadow-sm border" alt="{{ auction.title }}" style="width: 100%; max-height: 500px; object-fit: contain; background-color: #f8f9fa;">
                {% else %}
                    <div class="bg-secondary text-white d-flex align-items-center justify-content-center rounded" style="height: 400px;">ì´ë¯¸ì§€ ì—†ìŒ</div>
                {% endif %}
            </div>
        </div>

        <div class="col-md-5">
            <h2 class="fw-bold mb-3" style="font-size: 1.5rem;">
                {% if auction.is_national %}
                    <span class="badge bg-danger fs-6 align-middle me-1">âš¡ ì „êµ­</span>
                {% endif %}
                {{ auction.title }}
            </h2> 
            
            <div class="mb-4 pb-3 border-bottom">
                <span class="text-muted small">í˜„ì¬ê°€</span>
                <div class="d-flex align-items-end">
                    <h1 class="text-danger fw-bold mb-0 me-2" id="current-price-display">{{ auction.current_price }}<span class="fs-4">ì›</span></h1>
                    <span class="badge bg-secondary mb-2">{{ auction.bids.count }} ì…ì°°</span>
                </div>
                {% if auction.instant_price %}
                    <div class="text-muted small mt-1">å³ ì¦‰ì‹œêµ¬ë§¤ê°€: {{ auction.instant_price }}ì›</div>
                {% endif %}
            </div>

            <div id="auction-controls" class="d-grid gap-2 mb-4">
                {% if user.is_authenticated and user != auction.seller and auction.status == 'ACTIVE' %}
                    <form method="post" class="d-grid" id="bid-form">
                        {% csrf_token %}
                        <div class="input-group mb-2">
                            <input type="number" name="amount" class="form-control form-control-lg" 
                                   value="{{ auction.current_price|add:auction.bid_unit }}" 
                                   min="{{ auction.current_price|add:auction.bid_unit }}" 
                                   placeholder="ì…ì°°ê¸ˆì•¡">
                            <button class="btn btn-warning btn-lg fw-bold text-dark" type="submit" style="background-color: #fc0; border: none;">
                                ì…ì°°í•˜ê¸°
                            </button>
                        </div>
                    </form>
                    
                    {% if auction.instant_price %}
                    <form action="{% url 'auction_buy_now' auction.id %}" method="post" onsubmit="return confirm('ì¦‰ì‹œ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');" class="d-grid">
                        {% csrf_token %}
                        <button class="btn btn-danger btn-lg fw-bold">âš¡ ì¦‰ì‹œ êµ¬ë§¤í•˜ê¸°</button>
                    </form>
                    {% endif %}

                    <a href="{% url 'toggle_watchlist' auction.id %}" class="btn btn-outline-secondary">
                        {% if request.user in auction.watchers.all %}â¤ï¸ ì°œ ì·¨ì†Œ{% else %}ğŸ¤ ê´€ì‹¬ìƒí’ˆ ë“±ë¡{% endif %}
                    </a>
                {% endif %}

                {% if user == auction.seller %}
                    <div class="alert alert-warning text-center">
                        <strong>ğŸ‘¨â€ğŸ’¼ íŒë§¤ì ë©”ë‰´</strong><br>
                        {% if auction.status == 'ACTIVE' %}
                        <form action="{% url 'auction_close' auction.id %}" method="post" class="mt-2">
                            {% csrf_token %}
                            <button class="btn btn-sm btn-dark">ì¡°ê¸° ì¢…ë£Œí•˜ê¸°</button>
                        </form>
                        {% else %}
                        <span class="badge bg-dark">ì¢…ë£Œëœ ê²½ë§¤ì…ë‹ˆë‹¤</span>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            
            <div id="congrats-card" class="card border-success mb-4" 
                 style="display: {% if user == auction.bids.last.bidder and auction.status != 'ACTIVE' %}block{% else %}none{% endif %};">
                <div class="card-body text-center">
                    <h5 class="text-success fw-bold">ğŸ‰ ë‚™ì°°ì„ ì¶•í•˜í•©ë‹ˆë‹¤!</h5>
                    <p class="small text-muted">ê±°ë˜ê°€ ì™„ë£Œë˜ì—ˆë‹¤ë©´ íŒë§¤ìë¥¼ ìœ„í•´ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
                    <a href="{% url 'create_review' auction.id %}" class="btn btn-success">
                        âœï¸ ê±°ë˜ í›„ê¸° ë‚¨ê¸°ê¸°
                    </a>
                </div>
            </div>

            <div id="auction-end-card" class="card border-secondary mb-4 bg-light" 
                 style="display: {% if auction.status != 'ACTIVE' and user != auction.bids.last.bidder %}block{% else %}none{% endif %};">
                <div class="card-body text-center">
                    <h5 class="text-secondary fw-bold">â›” ê²½ë§¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h5>
                    <p class="small text-muted" id="winner-info-text">
                        {% if auction.bids.last %}
                            ë‚™ì°°ì: {{ auction.bids.last.bidder.nickname|default:auction.bids.last.bidder.username }}
                        {% else %}
                            ë‚™ì°°ì ì—†ì´ ì¢…ë£Œë¨
                        {% endif %}
                    </p>
                </div>
            </div>

            <div class="card mb-4 bg-light border-0">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <div class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center me-3" style="width: 50px; height: 50px;">
                            ğŸ‘¤
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold"><a href="#" class="text-dark text-decoration-none">{{ auction.seller.nickname|default:auction.seller.username }}</a></h6>
                            <small class="text-muted">ì‹ ìš©ë„: {{ auction.seller.reputation_score }}ì </small>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>ğŸ† ìš°ìˆ˜ íŒë§¤ì</span>
                        <a href="{% url 'seller_profile' auction.seller.id %}" class="text-decoration-none">íŒë§¤ì ì •ë³´ ë³´ê¸° &gt;</a>
                    </div>
                </div>
            </div>

            <table class="table table-sm text-small">
                <tbody>
                    <tr>
                        <th class="text-muted w-25">ì¹´í…Œê³ ë¦¬</th>
                        <td>{{ auction.category.name|default:"ê¸°íƒ€" }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">ìƒíƒœ</th>
                        <td>{{ auction.get_condition_display }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">ì§€ì—­</th>
                        <td>{{ auction.region.name|default:"ì „êµ­" }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">ë°°ì†¡ë¹„</th>
                        <td>{{ auction.get_shipping_payer_display }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">ì¢…ë£Œì¼ì‹œ</th>
                        <td>{{ auction.end_time|date:"Y-m-d H:i" }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div> <hr class="my-5">

    <div class="row">
        <div class="col-md-8">
            <h4 class="fw-bold mb-4 bg-light p-2 border-start border-4 border-warning">ìƒí’ˆ ì„¤ëª…</h4>
            <div class="p-3 border rounded bg-white" style="min-height: 300px;">
                {{ auction.description|linebreaksbr }}
            </div>

            <h4 class="fw-bold mb-4 mt-5 bg-light p-2 border-start border-4 border-primary">ìƒí’ˆ ë¬¸ì˜</h4>
            <form action="{% url 'auction_comment' auction.id %}" method="post" class="mb-4">
                {% csrf_token %}
                <div class="input-group">
                    <textarea name="content" class="form-control" rows="2" placeholder="íŒë§¤ìì—ê²Œ ë¬¸ì˜í•˜ê¸°..." required></textarea>
                    <button class="btn btn-outline-dark" type="submit">ë“±ë¡</button>
                </div>
            </form>
            <div class="list-group list-group-flush">
                {% for comment in auction.comments.all %}
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between">
                            <strong>{{ comment.writer.nickname|default:comment.writer.username }}</strong>
                            <small class="text-muted">{{ comment.created_at|date:"m-d H:i" }}</small>
                        </div>
                        <p class="mb-0 text-muted">{{ comment.content }}</p>
                    </div>
                {% empty %}
                    <p class="text-muted small">ì•„ì§ ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-4">
            <h5 class="fw-bold mb-3">ğŸª ì´ íŒë§¤ìì˜ ë‹¤ë¥¸ ìƒí’ˆ</h5>
            <div class="row g-2">
                {% for item in other_items %}
                <div class="col-6">
                    <div class="card h-100 border-0 shadow-sm">
                        {% if item.image %}
                            <img src="{{ item.image.url }}" class="card-img-top" alt="{{ item.title }}" style="height: 100px; object-fit: cover;">
                        {% else %}
                            <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 100px;">No Image</div>
                        {% endif %}
                        <div class="card-body p-2">
                            <h6 class="card-title text-truncate small mb-1">{{ item.title }}</h6>
                            <p class="card-text text-danger fw-bold small">{{ item.current_price }}ì›</p>
                            <a href="{% url 'auction_detail' item.id %}" class="stretched-link"></a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-muted small">íŒë§¤ ì¤‘ì¸ ë‹¤ë¥¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="mb-5"></div>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // 1. Toast ì•Œë¦¼ í•¨ìˆ˜
    function showToast(message, type = 'info') {
        let bgClass = 'text-bg-primary';
        let icon = 'ğŸ“¢';

        if (type === 'success') {
            bgClass = 'text-bg-success';
            icon = 'ğŸ‰';
        } else if (type === 'error' || type === 'danger') {
            bgClass = 'text-bg-danger';
            icon = 'âŒ';
        } else if (type === 'warning') {
            bgClass = 'text-bg-warning';
            icon = 'âš ï¸';
        }

        const toastHtml = `
            <div class="toast align-items-center ${bgClass} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body fw-bold">
                        ${icon} ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

        const toastContainer = document.querySelector('.toast-container');
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);

        const newToastEl = toastContainer.lastElementChild;
        const toast = new bootstrap.Toast(newToastEl, { delay: 3000 });
        toast.show();
        
        newToastEl.addEventListener('hidden.bs.toast', function () {
            newToastEl.remove();
        });
    }

    const auctionId = "{{ auction.id }}";
    // íŒŒì´ì¬ True/Falseë¥¼ JS true/falseë¡œ ë³€í™˜
    const isNational = "{{ auction.is_national|yesno:'true,false' }}"; 
    const currentUser = "{{ user.username }}";
    
    // 4. ë‚´ ìˆ«ì ID ê°€ì ¸ì˜¤ê¸° (ìˆ˜ì •ë¨)
    const currentUserId = document.getElementById('current-user-id').value;

    // 2. ì „êµ­ ê²½ë§¤ì¼ ë•Œë§Œ ì†Œì¼“ ì—°ê²°
    if (isNational === 'true') {
        console.log("ğŸ“¡ ì „êµ­ ì‹¤ì‹œê°„ ê²½ë§¤ ëª¨ë“œ: WebSocket ì—°ê²° ì‹œë„...");

        // ws:// í”„ë¡œí† ì½œ ì‚¬ìš©
        const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const chatSocket = new WebSocket(
            wsProtocol + window.location.host + '/ws/auction/' + auctionId + '/'
        );

        chatSocket.onopen = function(e) {
            console.log("âœ… ì†Œì¼“ ì—°ê²° ì„±ê³µ!");
        };

        // ë©”ì‹œì§€ ìˆ˜ì‹ 
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            // ì—ëŸ¬
            if (data.error) {
                showToast("ì…ì°° ì‹¤íŒ¨: " + data.error, 'error');
            } 
            // ì…ì°° ê°±ì‹   (ìƒˆë¡œê³ ì¹¨ X)
            else if (data.type === 'update') {
                updatePriceUI(data.amount, data.bidder);
                
                if (data.bidder === currentUser) {
                    showToast(`ì„±ê³µì ìœ¼ë¡œ ${data.amount}ì›ì— ì…ì°°í–ˆìŠµë‹ˆë‹¤!`, 'success');
                } else {
                    showToast(`ğŸ”” í˜¸ê°€ ê°±ì‹ ! ${data.bidder}ë‹˜ì´ ${data.amount}ì› ì…ì°°!`, 'info');
                }
            }
            // 5. ê²½ë§¤ ì¢…ë£Œ(ë‚™ì°°/ì¦‰ì‹œêµ¬ë§¤) ì²˜ë¦¬ ë¡œì§ ìˆ˜ì • (í•µì‹¬!)
            else if (data.type === 'sold_out' || data.type === 'auction_end') {
                updatePriceUI(data.amount, data.bidder);
                
                const winnerId = String(data.winner_id); // ì„œë²„ì—ì„œ ì˜¨ ë‚™ì°°ì ID (ë¬¸ìì—´ ë³€í™˜)
                const myId = String(currentUserId);      // ë‚´ ID
                
                // ê¸°ì¡´ ì…ì°° ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê¸°
                const controls = document.getElementById('auction-controls');
                if(controls) controls.style.display = 'none';

                // ë‚´ê°€ ë‚™ì°°ìì¸ ê²½ìš°
                if (myId && myId === winnerId) {
                    document.getElementById('congrats-card').style.display = 'block'; // ì¶•í•˜ ì¹´ë“œ ë³´ì´ê¸°
                    document.getElementById('auction-end-card').style.display = 'none';
                    showToast("ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ë‚™ì°°ë˜ì—ˆìŠµë‹ˆë‹¤!", 'success');
                } 
                // ë‚´ê°€ ë‚™ì°°ìê°€ ì•„ë‹Œ ê²½ìš°
                else {
                    document.getElementById('congrats-card').style.display = 'none'; 
                    document.getElementById('auction-end-card').style.display = 'block'; // ì¢…ë£Œ ì¹´ë“œ ë³´ì´ê¸°
                    const winnerName = data.winner_nickname || data.bidder || "ì•Œ ìˆ˜ ì—†ìŒ";
                    document.getElementById('winner-info-text').innerText = `ë‚™ì°°ì: ${winnerName}`;
                    showToast(`ğŸ“¢ ê²½ë§¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‚™ì°°ì: ${winnerName}`, 'warning');
                }

                // 3ì´ˆ ë’¤ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ë°ì´í„° ë™ê¸°í™”)
                setTimeout(() => {
                    location.reload();
                }, 3000); 
            }
        };

        // 3. ì†Œì¼“ ì—°ê²° ëŠê¹€
        chatSocket.onclose = function(e) {
            console.error('âŒ ì†Œì¼“ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
        };

        $(document).ready(function() {
            $("#bid-form").on("submit", function(e) {
                e.preventDefault(); 
                const bidAmount = $(this).find("input[name='amount']").val();
                
                chatSocket.send(JSON.stringify({
                    'action': 'bid',
                    'amount': bidAmount
                }));
            });
        });
    }

    function updatePriceUI(amount, bidder) {
        const priceTag = document.querySelector("#current-price-display");
        if(priceTag) {
            priceTag.innerHTML = `${amount}<span class="fs-4">ì›</span>`;
        }

        const inputField = document.querySelector("input[name='amount']");
        if(inputField) {
            // Django Template ë³€ìˆ˜ ëŒ€ì‹  JS ë³€ìˆ˜ë¡œ ê³„ì‚°í•˜ê±°ë‚˜, ë‹¨ìˆœ ì—…ë°ì´íŠ¸
            // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ í˜„ì¬ ê°’ + ë‹¨ìœ„ ë¡œì§ì€ ìœ ì§€í•˜ë˜, 
            // ì‹¤ì‹œê°„ì„±ì„ ìœ„í•´ì„  ì„œë²„ì—ì„œ next_bid_amountë¥¼ ë°›ëŠ” ê²Œ ë” ì¢‹ìŠµë‹ˆë‹¤.
            const unit = {{ auction.bid_unit }};
            const nextPrice = parseInt(amount) + unit;
            inputField.value = nextPrice;
            inputField.min = nextPrice;
        }
    }
</script>
{% endblock %}