# AWS EC2 런칭 가이드 2편: 서버 설정 및 배포 (초보자용)

> **목표**: 텅 빈 서버(EC2)에 Docker를 설치하고, 우리 프로젝트를 실행해서 전 세계에 공개하기  
> **소요 시간**: 약 20~30분

---

## 📚 목차

1.  [Step 1: 내 컴퓨터에서 서버로 접속하기](#step-1-내-컴퓨터에서-서버로-접속하기)
2.  [Step 2: 서버 환경 기초 공사 (Docker 설치)](#step-2-서버-환경-기초-공사-docker-설치)
3.  [Step 3: 프로젝트 코드 가져오기](#step-3-프로젝트-코드-가져오기)
4.  [Step 4: 환경 변수(.env) 설정](#step-4-환경-변수env-설정)
5.  [Step 5: 실행 및 확인](#step-5-실행-및-확인)
6.  [Step 6: 도메인 연결 및 SSL (자물쇠) 달기](#step-6-도메인-연결-및-ssl-자물쇠-달기)

---

## Step 1: 내 컴퓨터에서 서버로 접속하기

EC2는 Lightsail과 달리 브라우저 접속 버튼이 없습니다. (있긴 한데 불편합니다.)
내 컴퓨터의 터미널(PowerShell 또는 Git Bash)을 열어서 접속해봅시다.

### 1-1. 키 파일 준비
1편에서 다운로드 받은 `NeighborBid-Key.pem` 파일이 필요합니다.
가정: `C:\Users\내이름\Desktop` 에 있다고 치겠습니다.

### 1-2. 터미널 열기 및 접속
**Windows PowerShell**을 관리자 권한으로 실행하세요.

```powershell
# 1. 키 파일이 있는 폴더로 이동 (본인 경로에 맞게 수정!)
cd C:\Users\내이름\Desktop

# 2. 키 파일 권한 보안 설정 (이거 안 하면 에러 나요!)
# Windows용 명령어입니다. (Mac/Linux는 chmod 400 NeighborBid-Key.pem)
icacls.exe NeighborBid-Key.pem /reset
icacls.exe NeighborBid-Key.pem /grant:r "$($env:USERNAME):(r)"
icacls.exe NeighborBid-Key.pem /inheritance:r

# 3. 접속 시도 (고정 IP는 1편에서 만든 것)
ssh -i "NeighborBid-Key.pem" ubuntu@[내_고정_IP]
```

> **질문**: `Are you sure you want to continue connecting?` 라고 물어보면?
> **답변**: `yes` 라고 입력하고 엔터 치면 됩니다.

성공하면 화면이 이렇게 바뀝니다:
```bash
ubuntu@ip-172-31-0-0:~$ 
```

---

## Step 2: 서버 환경 기초 공사 (Docker 설치)

서버에 접속했다면, 이제 요리할 주방(Docker)을 만들어야 합니다.
아래 명령어들을 **한 줄씩 복사해서 붙여넣으세요**. (우클릭하면 붙여넣기 됨)

```bash
# 1. 시스템 업데이트 (목욕 재계)
sudo apt update && sudo apt upgrade -y

# 2. Docker 자동 설치 스크립트 실행
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 3. Docker 권한 설정 (매번 sudo 치기 귀찮으니까)
sudo usermod -aG docker ubuntu

# 4. 설정 적용을 위해 로그아웃 후 재접속
exit
```

**[중요]** `exit`으로 연결이 끊겼죠? **다시 `ssh` 명령어로 접속해주세요.**

접속 후 확인:
```bash
docker --version
# 결과: Docker version 24.x.x build ... 처럼 나오면 성공!
```

---

## Step 3: 프로젝트 코드 가져오기

이제 텅 빈 주방에 우리 요리 재료(코드)를 가져옵니다.

```bash
# 1. 홈 디렉토리로 이동
cd ~

# 2. 앱 폴더 만들기
mkdir apps && cd apps

# 3. 깃허브에서 코드 복사해오기 (주소는 본인 레포지토리 주소로 변경!)
git clone https://github.com/Start-to-End-Project/NeighborBid_Auction.git

# 4. 프로젝트 폴더로 이동
cd NeighborBid_Auction
```

---

## Step 4: 환경 변수(.env) 설정

서버에서 사용할 비밀번호들을 설정하는 파일입니다.

```bash
# .env 파일 생성 및 편집
nano .env
```

아래 내용을 복사해서 붙여넣고, **값만 본인 것으로 수정**하세요.

```ini
# Django 시크릿 키 (아무거나 복잡하게 입력 가능한데, 아래에서 생성법 알려드림)
DJANGO_SECRET_KEY=change_me_to_random_string

# 디버그 모드 끄기 (실전이니까!)
DJANGO_DEBUG=False

# 접속 허용할 주소 (도메인과 IP 모두 적어주세요)
ALLOWED_HOSTS=neighborbid.com,www.neighborbid.com,[내_고정_IP]

# 데이터베이스 설정 (변경 불필요, Docker 내부에서 알아서 함)
DB_NAME=neighborbid
DB_USER=postgres
DB_PASSWORD=my_secure_db_password
DB_HOST=db
DB_PORT=5432

# Redis 설정
REDIS_HOST=redis
```

**[저장하고 나오는 법]**
1. `Ctrl + O` 누르고 `Enter` (저장)
2. `Ctrl + X` (종료)

---

## Step 5: 실행 및 확인

이제 3_0 파일에서 분석했던 그 "밀키트"를 실행할 차례입니다.

```bash
# 1. 실행 명령어 (프로덕션 설정으로 실행)
docker compose -f docker-compose.prod.yml up -d --build

# 2. 잘 켜졌는지 확인
docker compose -f docker-compose.prod.yml ps
```

`State`가 모두 `Up`으로 되어있나요? 축하합니다! 서버가 켜졌습니다. 🎉

### 브라우저 접속 테스트
아직 도메인이 없으니까 IP로 접속해봅시다.
주소창에 `http://[내_고정_IP]` 입력!
(화면이 뜨면 성공입니다. "주의 요망" 뜨는 건 정상입니다.)

---

## Step 6: 도메인 연결 및 SSL (자물쇠) 달기

이제 못생긴 IP 주소 대신 멋진 도메인을 달아봅시다.

### 6-1. 도메인 연결 (DNS)
도메인을 산 사이트(가비아, 호스팅KR 등)에 가서 **DNS 설정**을 합니다.
(Lightsail 가이드와 똑같습니다!)

| 타입 | 호스트 | 값 (Value) |
| :--- | :--- | :--- |
| **A** | **@** | `[내_고정_IP]` |
| **A** | **www** | `[내_고정_IP]` |

### 6-2. SSL 인증서 발급 (Certbot)
도메인 연결 후 **10분 정도 기다렸다가** 아래 명령어를 실행하세요.
(서버 터미널에서 실행)

```bash
# 1. 인증서 발급 (이메일과 도메인 수정 필수!)
docker compose -f docker-compose.prod.yml run --rm --entrypoint "\
  certbot certonly --webroot -w /var/www/certbot \
    --email 내이메일@gmail.com \
    -d 내도메인.com \
    -d www.내도메인.com \
    --rsa-key-size 4096 \
    --agree-tos \
    --force-renewal" nginx

# 2. Nginx 재시작 (인증서 적용)
docker compose -f docker-compose.prod.yml restart nginx
```

### 🎉 최종 확인
이제 `https://내도메인.com` 으로 접속해보세요.
주소창에 🔒 자물쇠가 달리고 안전하게 접속된다면, **런칭 성공입니다!** 수고하셨습니다! 👏👏👏

---

### 자주 쓰는 명령어 모음 (보너스)

```bash
# 로그 확인 (에러 났을 때)
docker compose -f docker-compose.prod.yml logs -f web

# 서버 끄기
docker compose -f docker-compose.prod.yml down

# 코드 수정 후 재배포
git pull
docker compose -f docker-compose.prod.yml up -d --build
```
